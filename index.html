<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin SahabatKu Dashboard (V20.1 - MODIFIED)</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================================= */
        /* 1. Global & Theme Variables */
        /* ========================================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-color: #00CAFF; /* Biru terang */
            --secondary-color: #ffc107;
            --text-color: #333;
            --bg-light: #f7f9fc;
            --bg-card: #ffffff;
            --shadow-soft: 0 4px 15px rgba(0,0,0,0.05);
            --radius: 12px;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-light); 
            color: var(--text-color); 
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }
        .primary-color { color: var(--primary-color); }
        main { max-width: 1200px; margin: 20px auto; padding: 0 15px; }

        /* ========================================================= */
        /* 2. Navigation & Header (Mobile Ready) */
        /* ========================================================= */
        header { background: var(--bg-card); box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; max-width: 1200px; margin: 0 auto; }
        .logo { font-size: 22px; font-weight: 700; color: var(--primary-color); }
        .nav-menu { display: flex; }
        .nav-btn { padding: 10px 18px; color: #666; cursor: pointer; transition: all 0.3s; text-align: center; border-radius: 8px; margin: 0 4px; font-size: 14px; }
        .nav-btn.active { background: var(--primary-color); color: white; font-weight: 600; box-shadow: 0 4px 10px rgba(0, 202, 255, 0.3); transform: translateY(-2px); }
        .hamburger { display: none; font-size: 24px; cursor: pointer; color: var(--primary-color); }
        @media (max-width: 768px) {
            .nav-menu { display: none; flex-direction: column; position: absolute; top: 60px; left: 0; width: 100%; background: var(--bg-card); box-shadow: var(--shadow-soft); padding: 10px 0; }
            .nav-menu.open { display: flex; }
            .nav-btn { margin: 5px 15px; text-align: left; }
            .hamburger { display: block; }
            .header-content { padding: 15px; }
        }

        /* ========================================================= */
        /* 3. Filter & Search Styling */
        /* ========================================================= */
        .section { background: var(--bg-card); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow-soft); margin-bottom: 25px; display: none; }
        .section.active { display: block; }
        
        input:not([type="checkbox"]), textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; transition: all 0.3s; background-color: var(--bg-light); }
        
        .search-container { margin-bottom: 20px; display: flex; gap: 10px; }
        .search-container input[type="text"], .search-container select { flex-grow: 1; padding: 12px 15px; border-radius: 25px; border: 2px solid var(--primary-color); box-shadow: 0 2px 10px rgba(0, 202, 255, 0.1); font-size: 16px; background-color: #fff; }

        /* Multi Filter Controls - Tata Letak Fleksibel */
        .filter-controls { display: flex; flex-wrap: wrap; gap: 15px; padding: 15px; background: var(--bg-light); border-radius: var(--radius); margin-bottom: 25px; border: 1px solid #ddd; }
        .filter-controls > * { flex-grow: 1; min-width: 180px; }

        /* ========================================================= */
        /* 4. List/Card Layout (Medium Size & Horizontal Scroll) */
        /* *FIXED IMAGE RATIO 1:1 SQUARE* */
        /* ========================================================= */
        .horizontal-scroll-container { overflow-x: auto; -webkit-overflow-scrolling: touch; white-space: nowrap; padding-bottom: 15px; }
        .horizontal-scroll-container::-webkit-scrollbar { display: none; }
        .horizontal-scroll-container { -ms-overflow-style: none; scrollbar-width: none; }

        .list-medium { display: inline-flex; gap: 15px; padding: 10px 0; }
        
        .list-item-medium { 
            display: inline-block; width: 250px; max-width: 250px; flex-shrink: 0; background: var(--bg-card); 
            padding: 0; border-radius: 10px; box-shadow: var(--shadow-soft); overflow: hidden; 
            border: 1px solid #eee; transition: transform 0.3s ease, box-shadow 0.3s ease; 
        }
        .list-item-medium:active { transform: scale(0.98); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* === FIX: IMAGE RATIO 1:1 (SQUARE) === */
        .list-item-medium img { 
            width: 100%; 
            aspect-ratio: 1/1; /* Rasio 1:1 untuk semua gambar Kedai/Menu */
            object-fit: cover; 
            margin-bottom: 0; 
            height: auto;
        }
        
        .list-item-medium .list-item-content { padding: 10px 15px; }
        
        /* Status & Buttons */
        .status-indicator { display: inline-block; padding: 4px 10px; border-radius: 15px; font-weight: 600; font-size: 12px; margin-left: 5px; animation: pulse 2s infinite; }
        .status-open { background-color: #4CAF50; color: white; }
        .status-closed { background-color: #ff4d4f; color: white; animation: none; }
        
        .btn-primary { background-color: var(--primary-color); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-danger { background-color: #dc3545; }
        .btn-warning { background-color: #ff9800; }
        .btn-primary, .btn-secondary, .btn-danger, .btn-warning {
            padding: 10px 18px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.3s;
            border: none; margin-top: 10px; font-weight: 600; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-sm { padding: 8px 12px; font-size: 12px; margin-top: 5px; }

        /* Notification Styling */
        .notification-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .notification { padding: 12px 20px; border-radius: 8px; font-size: 14px; color: white; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(100%); min-width: 250px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .notification.show { opacity: 1; transform: translateY(0); }
        .notification.success { background-color: #4CAF50; }
        .notification.error { background-color: #f44336; }
        .notification.warning { background-color: #ff9800; }
        
        /* Modal Styling */
        .modal { display: none; justify-content: center; align-items: center; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 90%; min-width: 300px; max-height: 90%; overflow-y: auto; position: relative;}
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 20px; }
        .close-btn:hover, .close-btn:focus { color: #000; text-decoration: none; cursor: pointer; }

        /* Style untuk area Cropper di Modal */
        #imageToCrop { max-height: 40vh; }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo"><i class="fas fa-utensils primary-color"></i> Admin SahabatKu</div>
            <div class="hamburger" onclick="toggleMenu()">&#9776;</div>
            <div class="nav-menu" id="navMenu">
                <div class="nav-btn" onclick="openModal('restaurantModal', 'Tambah Kedai Baru', true)"><i class="fas fa-store"></i> Tambah Kedai</div>
                <div class="nav-btn active" onclick="showSection('restaurantList', this)"><i class="fas fa-list"></i> Daftar Kedai</div>
                <div class="nav-btn" onclick="showSection('menuList', this)"><i class="fas fa-list"></i> Daftar Menu</div>
                <div class="nav-btn" onclick="showSection('galleryList', this)"><i class="fas fa-images"></i> Galeri Kedai</div>
                </div>
        </div>
    </header>

    <main>
        <div id="restaurantList" class="section active">
            <h2><i class="fas fa-store primary-color"></i> Kelola Daftar Kedai</h2>
            <p id="currentWibTime" style="text-align: right; font-size: 14px; margin-top: -10px; margin-bottom: 20px; font-weight: 600; color: #555;"><i class="fas fa-clock"></i> Memuat Waktu Lokal Server (WIB)...</p>

            <div class="filter-controls">
                <div class="form-group search-container" style="flex-grow: 2;">
                    <input list="kedaiNamesList" id="searchRestaurantList" placeholder="Cari Nama Kedai di sini..." oninput="filterRestaurantList()">
                    <datalist id="kedaiNamesList"></datalist>
                </div>
                <div class="form-group search-container" style="flex-grow: 1;">
                    <select id="filterRestaurantStatusList" onchange="filterRestaurantList()">
                        <option value="">Semua Status</option>
                        <option value="open" selected>Buka</option>
                        <option value="closed">Tutup</option>
                    </select>
                </div>
            </div>
            
            <div class="horizontal-scroll-container">
                <div class="list-medium" id="restaurantItemsList">
                    <p style="text-align: center; color: #999; white-space: normal; padding: 10px; width: 300px;">Memuat data kedai...</p>
                </div>
            </div>
        </div>
        
        <div id="menuList" class="section">
            <h2><i class="fas fa-utensils primary-color"></i> Kelola Daftar Menu</h2>
            <div class="filter-controls">
                <div class="form-group search-container" style="flex-grow: 2; min-width: 250px;">
                    <input list="menuNamesList" id="searchMenuList" placeholder="Cari Nama Menu di sini..." oninput="filterMenuList()">
                    <datalist id="menuNamesList"></datalist>
                </div>
                <div class="form-group search-container" style="flex-grow: 1;">
                    <select id="filterMenuKedaiList" onchange="filterMenuList()">
                        <option value="">Semua Kedai</option>
                    </select>
                </div>
                <div class="form-group search-container" style="flex-grow: 1;">
                    <select id="filterMenuKedaiStatus" onchange="filterMenuList()">
                        <option value="">Status Kedai (Semua)</option>
                        <option value="open" selected>Kedai Buka</option>
                        <option value="closed">Kedai Tutup</option>
                    </select>
                </div>
                <div class="form-group search-container" style="flex-grow: 1;">
                    <select id="filterMenuCategoryList" onchange="filterMenuList()">
                        <option value="">Semua Kategori</option>
                        </select>
                </div>
            </div>
            
            <div id="menuItemsList">
                <p style="text-align: center; color: #999;">Memuat data menu...</p>
            </div>
        </div>
        
        <div id="galleryList" class="section">
            <h2><i class="fas fa-images primary-color"></i> Kelola Galeri Kedai</h2>
            <div class="filter-controls">
                <div class="form-group search-container" style="flex-grow: 2; min-width: 250px;">
                    <input list="galleryNamesList" id="searchGalleryList" placeholder="Cari Nama Galeri/Kedai di sini..." oninput="filterGalleryList()">
                    <datalist id="galleryNamesList"></datalist>
                </div>
                <div class="form-group search-container" style="flex-grow: 1;">
                    <select id="filterGalleryKedaiStatus" onchange="filterGalleryList()">
                        <option value="">Status Kedai (Semua)</option>
                        <option value="open" selected>Kedai Buka</option> <option value="closed">Kedai Tutup</option>
                    </select>
                </div>
                <div class="form-group search-container" style="flex-grow: 1;">
                    <select id="filterGalleryVisibility" onchange="filterGalleryList()">
                        <option value="">Semua Visibilitas Galeri</option>
                        <option value="published" selected>Tampil</option> <option value="hidden">Tersembunyi</option>
                    </select>
                </div>
            </div>
            
            <div id="galleryItemsList">
                <p style="text-align: center; color: #999;">Memuat data galeri...</p>
            </div>
        </div>
        </main>

    <div id="notification-container" class="notification-container"></div>
    
    <div id="restaurantModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('restaurantModal')">&times;</span>
            <h3 id="restaurantModalTitle" class="primary-color" style="margin-bottom: 20px;"><i class="fas fa-store"></i> Kelola Kedai</h3>
            <form id="restaurantFormData">
                <input type="hidden" id="restaurantId">
                <div class="form-group" style="margin-bottom: 15px;"><label for="restaurantName">Nama Kedai:</label><input type="text" id="restaurantName" required></div>
                <div class="form-group" style="margin-bottom: 15px;"><label for="restaurantAddress">Alamat:</label><input type="text" id="restaurantAddress" required></div>
                
                <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--primary-color); font-size: 16px;"><i class="fas fa-user-lock"></i> Akses Kedai (Login)</h4>
                <div class="form-group" style="margin-bottom: 15px;"><label for="restaurantUsername">Username Kedai:</label><input type="text" id="restaurantUsername"></div>
                <div class="form-group" style="margin-bottom: 15px;"><label for="restaurantPassword">Password Kedai (Biarkan kosong jika tidak ingin diubah):</label><input type="text" id="restaurantPassword"></div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Status Kedai:</label>
                    <select id="statusModeSelect" onchange="toggleManualControls(this.value)">
                        <option value="auto">Otomatis (Berdasarkan Jam)</option>
                        <option value="manual">Manual</option>
                    </select>
                </div>

                <div id="autoControls" class="form-group" style="margin-bottom: 15px;"><label>Jam Operasional (WIB):</label><div style="display: flex; gap: 10px;"><input type="time" id="openTime" value="08:00" style="width: 50%;" required><input type="time" id="closeTime" value="22:00" style="width: 50%;" required></div></div>

                <div id="manualControls" class="form-group" style="display: none; margin-bottom: 15px;">
                    <label>Status Manual:</label>
                    <input type="hidden" id="manualStatusActualValue" value="open">
                    <label style="display: block; background: #ddd; padding: 10px; border-radius: 8px;">
                        <input type="checkbox" id="manualStatusToggle" onchange="updateManualStatus(this)" checked> Kedai Sedang Buka
                    </label>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="restaurantImageFile">Foto Kedai (Rasio 1:1, akan dipangkas):</label>
                    <input type="file" id="restaurantImageFile" accept="image/*" onchange="previewImage('restaurant')">
                </div>
                
                <img id="restaurantImagePreview" style="display: none; width: 100%; aspect-ratio: 1/1; object-fit: contain; border: 1px solid #ddd; padding: 5px; border-radius: 8px; margin-top: 10px; margin-bottom: 15px;">
                
                <button type="button" class="btn-primary" onclick="saveRestaurant()" style="width: 100%;"><i class="fas fa-save"></i> Simpan Kedai</button>
            </form>
        </div>
    </div>
    
    <div id="menuModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('menuModal')">&times;</span>
            <h3 class="primary-color" style="margin-bottom: 20px;"><i class="fas fa-utensils"></i> Kelola Menu untuk Kedai: <span id="menuTargetKedaiName" style="font-size: 16px; font-weight: 600;"></span></h3>
            <form id="menuFormData">
                <input type="hidden" id="menuId"> <input type="hidden" id="menuRestaurantId"> 
                <div class="form-group" style="margin-bottom: 15px;"><label for="menuName">Nama Menu:</label><input type="text" id="menuName" required></div>
                
                <div class="form-group" style="margin-bottom: 15px;"><label for="menuPriceDisplay">Harga (cth: 10.000):</label><input type="text" id="menuPriceDisplay" placeholder="cth: 10.000" required><input type="hidden" id="menuPrice"></div>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Kategori Menu (Pilih/Ketuk):</label>
                    <div class="category-options" id="menuCategoryOptions" style="display: flex; flex-wrap: wrap; gap: 8px; border: 1px solid #ddd; padding: 10px; border-radius: 8px; background-color: var(--bg-light);">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="menuImageFile">Foto Menu (Rasio 1:1, akan dipangkas):</label>
                    <input type="file" id="menuImageFile" accept="image/*" onchange="previewImage('menu')">
                </div>
                
                <img id="menuImagePreview" style="display: none; max-width: 100%; aspect-ratio: 1/1; object-fit: contain; margin-bottom: 15px; border: 1px solid #ddd; padding: 5px; border-radius: 8px;">
                
                <button type="button" class="btn-primary" onclick="saveMenu()" style="width: 100%;"><i class="fas fa-save"></i> Simpan Menu</button>
            </form>
        </div>
    </div>
    
    <div id="galleryModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('galleryModal')">&times;</span>
            <h3 class="primary-color" style="margin-bottom: 20px;"><i class="fas fa-images"></i> Kelola Galeri untuk Kedai: <span id="galleryTargetKedaiName" style="font-size: 16px; font-weight: 600;"></span></h3>
            <form id="galleryFormData">
                <input type="hidden" id="galleryId"> <input type="hidden" id="galleryRestaurantId"> 
                <div class="form-group" style="margin-bottom: 15px;"><label for="galleryName">Nama Galeri:</label><input type="text" id="galleryName"></div>
                
                <div class="form-group" style="margin-bottom: 15px;"><label for="galleryDescription">Keterangan Galeri:</label><textarea id="galleryDescription" rows="3" placeholder="Deskripsi singkat galeri/foto"></textarea></div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="galleryImageFile">Foto Galeri (Tidak di-crop, Full Size):</label>
                    <input type="file" id="galleryImageFile" accept="image/*" onchange="previewImage('gallery', true)"> </div>
                
                <img id="galleryImagePreview" style="display: none; max-width: 100%; object-fit: contain; margin-bottom: 15px; border: 1px solid #ddd; padding: 5px; border-radius: 8px; aspect-ratio: auto; height: auto;">
                
                <button type="button" class="btn-primary" onclick="saveGallery()" style="width: 100%;"><i class="fas fa-save"></i> Simpan Galeri</button>
            </form>
        </div>
    </div>
    <div id="croppingModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-btn" onclick="closeModal('croppingModal')">&times;</span>
            <h3 class="primary-color" style="margin-bottom: 20px;"><i class="fas fa-crop-alt"></i> Pangkas Gambar (Rasio 1:1)</h3>
            <div style="max-height: 400px; overflow: hidden; margin-bottom: 15px; border: 1px solid #eee;">
                 <img id="imageToCrop" style="max-width: 100%; display: block;">
            </div>
            <button type="button" class="btn-primary" onclick="cropAndSave()" style="width: 100%;"><i class="fas fa-check"></i> Selesai Memangkas</button>
        </div>
    </div>
    
    <script>
        // =============================================================
        //          ⚠️ KONFIGURASI DARI PENGGUNA ⚠️
        //    (WAJIB DIGANTI DENGAN KUNCI DAN DATA ASLI ANDA)
        // =============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyApP7-PPtMf3c4yn_Yzm-xYvkKPf9K1N4Y",
            authDomain: "daftarkedaikemitraan.firebaseapp.com",
            databaseURL: "https://daftarkedaikemitraan-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "daftarkedaikemitraan",
            storageBucket: "daftarkedaikemitraan.firebasestorage.app",
            messagingSenderId: "543218937987",
            appId: "1:543218937987:web:a40e427d6befb6c866ebb6",
            measurementId: "G-C66WQ6FHX1"
        };
        
        // **KONFIGURASI CLOUDINARY ASLI (WAJIB DISESUAIKAN)**
        const CLOUDINARY_CLOUD_NAME = 'sahabatkugroup'; // Ganti dengan Cloud Name Anda
        const CLOUDINARY_UPLOAD_PRESET = 'sahabatku_delivery'; // **WAJIB DIGANTI DENGAN UNSIGNED UPLOAD PRESET ANDA**
        const CLOUDINARY_API_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
        
        const DEFAULT_RESTAURANT_IMAGE = 'https://via.placeholder.com/400x400/00CAFF/ffffff?text=FOTO+KEDAI+(1:1)'; 
        const DEFAULT_MENU_IMAGE = 'https://via.placeholder.com/400x400/4CAF50/ffffff?text=FOTO+MENU+(1:1)'; 
        // START NEW: DEFAULT IMAGE GALERI
        const DEFAULT_GALLERY_IMAGE = 'https://via.placeholder.com/400x400/9C27B0/ffffff?text=FOTO+GALERI';
        // END NEW: DEFAULT IMAGE GALERI
        // =============================================================

        // Inisialisasi Firebase
        if (firebase.apps.length === 0) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();
        const RESTAURANT_REF = db.ref('restaurants');
        const MENU_REF = db.ref('menus');
        // START NEW: REF GALERI
        const GALLERY_REF = db.ref('galleries');
        // END NEW: REF GALERI

        let RESTAURANTS = {};
        let MENUS = {};
        // START NEW: DATA GALERI
        let GALLERIES = {}; 
        // END NEW: DATA GALERI
        let selectedMenuCategories = []; 
        // START NEW: FLAG SINKRONISASI
        let dataLoaded = { restaurants: false, menus: false, galleries: false };
        // END NEW: FLAG SINKRONISASI

        // **CROPPING GLOBAL VARIABLES**
        let currentCropper = null;
        let imageToCropType = ''; // 'restaurant' or 'menu'

        // Kategori Master
        const MENU_CATEGORIES = [
            'Jajanan', 'Minuman Dingin', 'Makanan Manis', 'Cepat Saji', 'Aneka Nasi', 'Ayam & Bebek', 'Kopi', 'Non-Kopi',
            'Bakmi', 'Seafood', 'Roti', 'Sate', 'Bakso & Soto', 'Martabak', 'Gorengan','Cemilan', 'Mie', 'Jus', 'Es Teh','Lauk','Ikan','Nasi Goreng','Seblak','Sarapan Pagi','Ayam Geprek','Minuman Kekinian','Chiken'
        ];

        // --- FUNGSI UTILITY & UI ---
        const notify = (message, type = 'success') => {
            const container = document.getElementById('notification-container');
            const icon = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-triangle' : type === 'warning' ? 'fas fa-exclamation' : 'fas fa-info-circle';
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.innerHTML = `<i class="${icon}"></i> ${message}`;
            container.appendChild(notif);
            setTimeout(() => { notif.classList.add('show'); }, 10);
            setTimeout(() => { notif.classList.remove('show'); setTimeout(() => notif.remove(), 500); }, 4000);
        };
        const formatRupiah = (angka) => {
            if (angka === undefined || angka === null || String(angka).replace(/\D/g, '') === '') return '0';
            const parsed = String(angka).replace(/\D/g, '');
            return parseInt(parsed).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };
        const getCurrentWibTimeComponents = () => {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Jakarta' });
            const parts = formatter.formatToParts(now);
            const hour = parts.find(p => p.type === 'hour').value;
            const minute = parts.find(p => p.type === 'minute').value;
            return { hour: parseInt(hour), minute: parseInt(minute), second: now.getSeconds() };
        };
        const checkRestaurantStatus = (openTime, closeTime, statusMode, manualStatus) => {
             // 1. Cek Mode Manual
             if (statusMode === 'manual') {
                const statusText = manualStatus === 'open' ? 'Buka (Manual)' : 'Tutup (Manual)';
                return { status: statusText, is_open: manualStatus === 'open' };
            }
            if (!openTime || !closeTime) return { status: 'Unknown', is_open: false };
            
            // 2. Cek Mode Otomatis (Berdasarkan WIB)
            const { hour: nowHour, minute: nowMinute } = getCurrentWibTimeComponents();
            const nowMinutes = nowHour * 60 + nowMinute;
            const toMinutes = (timeStr) => { const [h, m] = timeStr.split(':').map(Number); return h * 60 + m; };
            const openMinutes = toMinutes(openTime);
            const closeMinutes = toMinutes(closeTime);

            let isOpen;
            // Kasus normal (buka dan tutup di hari yang sama)
            if (openMinutes <= closeMinutes) { 
                isOpen = nowMinutes >= openMinutes && nowMinutes < closeMinutes; 
            } 
            // Kasus lintas hari (buka malam, tutup pagi)
            else { 
                isOpen = nowMinutes >= openMinutes || nowMinutes < closeMinutes; 
            }
            
            const status = isOpen ? 'Buka' : 'Tutup';
            return { status: status, is_open: isOpen };
        };
        const updateWibTimeDisplay = () => {
            const { hour, minute, second } = getCurrentWibTimeComponents();
            const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:${String(second).padStart(2, '0')}`;
            document.getElementById('currentWibTime').innerHTML = `<i class="fas fa-clock"></i> Waktu Lokal Server (WIB): ${timeStr}`;
            
            const activeSectionId = document.querySelector('.section.active')?.id;
            
            // Perbarui list status setiap 5 detik
            // START MODIFIED: check all dataLoaded flags and call filterGalleryList
            if (second % 5 === 0 && dataLoaded.restaurants && dataLoaded.menus && dataLoaded.galleries) { 
                if (activeSectionId === 'restaurantList') { filterRestaurantList(); }
                else if (activeSectionId === 'menuList') { filterMenuList(); }
                else if (activeSectionId === 'galleryList') { filterGalleryList(); }
            }
            // END MODIFIED
        };

        // **FIX: IMPLEMENTASI UPLOAD CLOUDINARY ASLI**
        const uploadImageToCloudinary = async (file) => { 
             if (!file) { return null; }
             
             notify('Mengunggah gambar ke Cloudinary...', 'warning'); 
             
             const formData = new FormData();
             formData.append('file', file);
             formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

             try {
                const response = await fetch(CLOUDINARY_API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Gagal upload: Status ${response.status}`);
                }
                
                const data = await response.json();
                notify('Upload gambar berhasil ke Cloudinary!', 'success'); 
                return data.secure_url; 
            } catch (error) {
                notify(`ERROR UPLOAD: ${error.message}. Pastikan CLOUDINARY_UPLOAD_PRESET Anda sudah diatur!`, 'error');
                return null;
            }
        };

        // **MODIFIED: FUNGSI PREVIEW GAMBAR (MENAMBAH isNoCrop)**
        window.previewImage = (type, isNoCrop = false) => { 
            const fileInput = document.getElementById(`${type}ImageFile`);
            // Hapus properti file yang dipangkas sebelumnya
            delete fileInput.croppedFile; 
            
            const file = fileInput.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById(`${type}ImagePreview`);

                    if (isNoCrop) {
                        // START NEW: LOGIKA TANPA CROP (UNTUK GALERI)
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        // Simpan file asli sebagai "croppedFile" untuk diunggah
                        fileInput.croppedFile = file; 
                        
                        if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
                        closeModal('croppingModal');
                        
                        notify('Gambar siap diunggah (tanpa pangkas)!', 'success');
                        // END NEW: LOGIKA TANPA CROP

                    } else {
                        // Logika lama: Buka Cropping Modal (UNTUK KEDAI & MENU)
                        const image = document.getElementById('imageToCrop');
                        image.src = e.target.result;
                        imageToCropType = type;
                        openModal('croppingModal', ''); 

                        setTimeout(() => {
                            if (currentCropper) {
                                currentCropper.destroy();
                            }
                            currentCropper = new Cropper(image, {
                                aspectRatio: 1, 
                                viewMode: 1,
                                responsive: true,
                                background: false
                            });
                        }, 50); 
                    }
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById(`${type}ImagePreview`).style.display = 'none';
                if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
            }
        };

        // **FUNGSI BARU: CROP DAN SIMPAN HASILNYA**
        window.cropAndSave = () => {
            if (!currentCropper) { notify('Cropper belum diinisialisasi.', 'error'); return; }

            // Dapatkan data kanvas yang dipangkas sebagai Blob
            currentCropper.getCroppedCanvas({
                width: 400, 
                height: 400,
            }).toBlob(async (blob) => {
                if (!blob) {
                    notify('Gagal membuat gambar yang dipangkas.', 'error');
                    closeModal('croppingModal');
                    return;
                }
                
                const previewId = `${imageToCropType}ImagePreview`;
                const fileInputId = `${imageToCropType}ImageFile`;

                // Buat objek File dari Blob untuk diunggah nanti
                const croppedFile = new File([blob], `cropped_${imageToCropType}_${new Date().getTime()}.png`, { type: 'image/png' });
                
                // Simpan objek file yang dipangkas pada elemen input file
                document.getElementById(fileInputId).croppedFile = croppedFile;
                
                // Tampilkan pratinjau dari file yang dipangkas
                const preview = document.getElementById(previewId);
                preview.src = URL.createObjectURL(croppedFile);
                preview.style.display = 'block';

                closeModal('croppingModal');
                // Hancurkan cropper setelah selesai
                currentCropper.destroy();
                currentCropper = null; 
                notify('Gambar berhasil dipangkas dan siap diunggah!', 'success');
            }, 'image/png');
        };


        window.toggleMenu = () => { document.getElementById('navMenu').classList.toggle('open'); };
        const closeModal = (modalId) => { 
            document.getElementById(modalId).style.display = 'none'; 
            document.getElementById(modalId).classList.remove('show'); 
            
            // Hancurkan Cropper saat modal cropping ditutup tanpa save
            if (modalId === 'croppingModal' && currentCropper) {
                 currentCropper.destroy(); 
                 currentCropper = null; 
            }
        };
        const openModal = (modalId, title, isNew = false) => { 
            document.getElementById(modalId).style.display = 'flex'; 
            document.getElementById(modalId).classList.add('show'); 
            const titleEl = document.getElementById(modalId + 'Title'); 
            if(titleEl) titleEl.textContent = title; 
            
            // Reset form jika ini adalah entri baru
            if (isNew && modalId === 'restaurantModal') {
                document.getElementById('restaurantFormData').reset();
                document.getElementById('restaurantId').value = '';
                document.getElementById('restaurantImagePreview').style.display = 'none';
                document.getElementById('restaurantImageFile').value = ''; 
                delete document.getElementById('restaurantImageFile').croppedFile; // Hapus file pangkas
                document.getElementById('statusModeSelect').value = 'auto';
                toggleManualControls('auto');
                
                // START NEW: Reset Username & Password
                document.getElementById('restaurantUsername').value = '';
                document.getElementById('restaurantPassword').value = '';
                // END NEW: Reset Username & Password
            }
        };
        window.showSection = (sectionId, button) => {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            button.classList.add('active');
            if (document.getElementById('navMenu').classList.contains('open')) toggleMenu();
            
            // Trigger load data setelah pindah section, hanya jika data sudah loaded
            if (dataLoaded.restaurants && dataLoaded.menus && dataLoaded.galleries) {
                if (sectionId === 'restaurantList') filterRestaurantList();
                if (sectionId === 'menuList') filterMenuList();
                if (sectionId === 'galleryList') filterGalleryList(); // ADDED
            }
        };
        window.toggleManualControls = (mode) => { 
            document.getElementById('autoControls').style.display = mode === 'auto' ? 'block' : 'none';
            document.getElementById('manualControls').style.display = mode === 'manual' ? 'block' : 'none';
        }
        window.updateManualStatus = (checkbox) => {
            document.getElementById('manualStatusActualValue').value = checkbox.checked ? 'open' : 'closed';
        };
        
        window.renderMenuCategoryOptions = (selectedCats = []) => { 
            const container = document.getElementById('menuCategoryOptions');
            container.innerHTML = '';
            selectedMenuCategories = [...selectedCats]; 
            
            MENU_CATEGORIES.forEach(cat => {
                const isSelected = selectedCats.includes(cat);
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = cat;
                button.style.cssText = `padding: 8px 12px; border-radius: 20px; font-size: 13px; margin: 4px 0; cursor: pointer; transition: all 0.3s; border: 1px solid ${isSelected ? 'var(--primary-color)' : '#ccc'}; background-color: ${isSelected ? 'var(--primary-color)' : '#fff'}; color: ${isSelected ? 'white' : '#555'};`;
                button.onclick = () => {
                    const index = selectedMenuCategories.indexOf(cat);
                    if (index > -1) { 
                        selectedMenuCategories.splice(index, 1); 
                        button.style.backgroundColor = '#fff'; 
                        button.style.color = '#555'; 
                        button.style.borderColor = '#ccc'; 
                    } 
                    else { 
                        selectedMenuCategories.push(cat); 
                        button.style.backgroundColor = 'var(--primary-color)'; 
                        button.style.color = 'white'; 
                        button.style.borderColor = 'var(--primary-color)'; 
                    }
                };
                container.appendChild(button);
            });
        };


        // --- LOGIKA CRUD UTAMA ---
        // MODIFIED: checkDataLoadAndRender
        const checkDataLoadAndRender = () => {
             // Karena filter default sudah disetel di HTML, kita hanya perlu memanggil fungsi filternya
             if (dataLoaded.restaurants && dataLoaded.menus && dataLoaded.galleries) {
                 filterRestaurantList();
                 filterMenuList();
                 filterGalleryList(); // ADDED
             }
        }

        // MODIFIED: fetchAllData
        const fetchAllData = () => {
            RESTAURANT_REF.on('value', (snapshot) => {
                RESTAURANTS = snapshot.val() || {};
                dataLoaded.restaurants = true;
                populateDatalists(); 
                checkDataLoadAndRender(); 
            }, (error) => {
                 notify(`Firebase Error (Restaurants): ${error.message}`, 'error');
                 dataLoaded.restaurants = true;
                 checkDataLoadAndRender(); 
            });
            
            MENU_REF.on('value', (snapshot) => {
                MENUS = snapshot.val() || {};
                dataLoaded.menus = true;
                populateDatalists(); 
                checkDataLoadAndRender(); 
            }, (error) => {
                 notify(`Firebase Error (Menus): ${error.message}`, 'error');
                 dataLoaded.menus = true;
                 checkDataLoadAndRender(); 
            });
            
            // START NEW: FETCH GALLERY DATA
            GALLERY_REF.on('value', (snapshot) => {
                GALLERIES = snapshot.val() || {};
                dataLoaded.galleries = true;
                populateDatalists(); 
                checkDataLoadAndRender(); 
            }, (error) => {
                 notify(`Firebase Error (Galleries): ${error.message}`, 'error');
                 dataLoaded.galleries = true;
                 checkDataLoadAndRender(); 
            });
            // END NEW: FETCH GALLERY DATA
        };
        
        // CRUD KEDAI
        // START MODIFIED: saveRestaurant (Added Username & Password)
        window.saveRestaurant = async () => {
            const id = document.getElementById('restaurantId').value || RESTAURANT_REF.push().key;
            const name = document.getElementById('restaurantName').value;
            const address = document.getElementById('restaurantAddress').value;
            const username = document.getElementById('restaurantUsername').value; // NEW
            const password = document.getElementById('restaurantPassword').value; // NEW (can be empty)
            const openTime = document.getElementById('openTime').value;
            const closeTime = document.getElementById('closeTime').value;
            
            const statusMode = document.getElementById('statusModeSelect').value;
            const manualStatus = document.getElementById('manualStatusActualValue').value;

            // Dapatkan file yang telah dipangkas (jika ada) atau file mentah
            const imageFileInput = document.getElementById('restaurantImageFile');
            const fileToUpload = imageFileInput.croppedFile || imageFileInput.files[0];
            const newPassword = document.getElementById('restaurantPassword').value.trim();
            const finalPassword = newPassword === '' ? (RESTAURANTS[id]?.password || '') : newPassword;
            if (!name || !address || (statusMode === 'auto' && (!openTime || !closeTime))) {
                notify('Mohon isi Nama Kedai, Alamat, dan Jam Operasional yang benar!', 'error'); return;
            }
            
            // NEW: Cek Username. Password Boleh Kosong (berarti tidak diubah/dibuat)
            if (!username) {
                 notify('Mohon isi Username Kedai.', 'error'); return;
            }

            let imageUrl = RESTAURANTS[id]?.image || DEFAULT_RESTAURANT_IMAGE;
            if (fileToUpload) { 
                imageUrl = await uploadImageToCloudinary(fileToUpload); 
                imageFileInput.croppedFile = null; // Hapus file pangkas sementara
                if (!imageUrl) { 
                    notify('Gagal mengunggah gambar kedai. Menggunakan foto lama/default.', 'warning'); 
                    imageUrl = RESTAURANTS[id]?.image || DEFAULT_RESTAURANT_IMAGE;
                }
            } 

            const isPublished = RESTAURANTS[id]?.isPublished !== false; 
            
            // Tentukan password yang akan disimpan
            let passwordToSave = RESTAURANTS[id]?.password || ''; // Ambil password lama
            if (password) {
                // Jika input password tidak kosong, gunakan password baru
                passwordToSave = password; 
            } else if (!document.getElementById('restaurantId').value) {
                // Jika ini entri BARU dan password kosong
                notify('Password kedai baru tidak boleh kosong!', 'error'); return;
            }

            const data = {
                id, name, address, openTime: openTime, closeTime: closeTime, image: imageUrl,
                statusMode: statusMode, manualStatus: manualStatus, isPublished: isPublished,
                username: username, // NEW
                password: passwordToSave, // NEW
                password: finalPassword,
                updatedAt: new Date().toISOString()
            };

            RESTAURANT_REF.child(id).set(data)
                .then(() => { notify(`Kedai ${name} berhasil disimpan!`, 'success'); closeModal('restaurantModal'); })
                .catch(error => notify('Gagal menyimpan kedai: ' + error.message, 'error'));
        };
        // END MODIFIED: saveRestaurant
        
        window.toggleRestaurantVisibility = (id, currentlyPublished) => {
            const newStatus = !currentlyPublished;
            const actionText = newStatus ? 'ditampilkan' : 'disembunyikan';
            RESTAURANT_REF.child(id).update({ isPublished: newStatus })
                .then(() => notify(`Kedai berhasil ${actionText}!`, 'success'))
                .catch(error => notify('Gagal mengubah visibilitas: ' + error.message, 'error'));
        };
        
        window.deleteRestaurant = (id, name) => {
            if (confirm(`Yakin ingin menghapus kedai ${name} beserta semua menunya dan galerinya? Tindakan ini tidak dapat dibatalkan!`)) {
                RESTAURANT_REF.child(id).remove()
                    .then(() => {
                        Object.values(MENUS).filter(m => m.restaurantId === id).forEach(m => MENU_REF.child(m.id).remove());
                        // START NEW: HAPUS GALERI TERKAIT
                        Object.values(GALLERIES).filter(g => g.restaurantId === id).forEach(g => GALLERY_REF.child(g.id).remove());
                        // END NEW: HAPUS GALERI TERKAIT
                        notify('Kedai, menu, dan galeri terkait berhasil dihapus.', 'danger');
                    })
                    .catch(error => notify('Gagal menghapus kedai: ' + error.message, 'error'));
            }
        };

        // START MODIFIED: editRestaurantForm (Added Username & Password)
        window.editRestaurantForm = (id) => {
            const r = RESTAURANTS[id];
            if (!r) return;
            document.getElementById('restaurantId').value = r.id;
            document.getElementById('restaurantName').value = r.name;
            document.getElementById('restaurantAddress').value = r.address;
            
            // NEW: Tampilkan Username dan set password kosong agar tidak terkirim jika tidak diubah
            document.getElementById('restaurantUsername').value = r.username || ''; 
            document.getElementById('restaurantPassword').value = r.password || '';
            document.getElementById('restaurantPassword').placeholder = r.password ? 'Terisi (Biarkan kosong jika tidak ingin diubah)' : 'Belum ada (Wajib diisi)';
            // END NEW

            document.getElementById('openTime').value = r.openTime || '08:00';
            document.getElementById('closeTime').value = r.closeTime || '22:00';
            document.getElementById('restaurantImagePreview').src = r.image || DEFAULT_RESTAURANT_IMAGE;
            document.getElementById('restaurantImagePreview').style.display = 'block';
            document.getElementById('restaurantImageFile').value = ''; // Clear file input
            delete document.getElementById('restaurantImageFile').croppedFile; // Hapus file pangkas

            const statusMode = r.statusMode || 'auto';
            document.getElementById('statusModeSelect').value = statusMode;
            toggleManualControls(statusMode);
            
            const isManualOpen = (r.manualStatus || 'open') === 'open';
            document.getElementById('manualStatusToggle').checked = isManualOpen;
            document.getElementById('manualStatusActualValue').value = r.manualStatus || 'open';
            
            openModal('restaurantModal', `Edit Kedai: ${r.name}`);
        };
        // END MODIFIED: editRestaurantForm


        // CRUD MENU
        window.openMenuFormForRestaurant = (restaurantId, restaurantName) => {
            document.getElementById('menuFormData').reset();
            document.getElementById('menuId').value = '';
            document.getElementById('menuRestaurantId').value = restaurantId;
            document.getElementById('menuName').value = '';
            document.getElementById('menuPriceDisplay').value = '';
            document.getElementById('menuPrice').value = '';
            document.getElementById('menuTargetKedaiName').textContent = restaurantName;
            document.getElementById('menuImagePreview').src = ''; 
            document.getElementById('menuImagePreview').style.display = 'none';
            document.getElementById('menuImageFile').value = ''; 
            delete document.getElementById('menuImageFile').croppedFile; // Hapus file pangkas
            renderMenuCategoryOptions([]); 
            openModal('menuModal', `Tambah Menu untuk ${restaurantName}`);
        };

        window.saveMenu = async () => {
            const id = document.getElementById('menuId').value || MENU_REF.push().key;
            const restaurantId = document.getElementById('menuRestaurantId').value;
            const name = document.getElementById('menuName').value;
            const priceRaw = document.getElementById('menuPrice').value;
            const categories = selectedMenuCategories;
            const kedaiName = document.getElementById('menuTargetKedaiName').textContent;
            
            // Dapatkan file yang telah dipangkas (jika ada) atau file mentah
            const imageFileInput = document.getElementById('menuImageFile');
            const fileToUpload = imageFileInput.croppedFile || imageFileInput.files[0];

            if (!name || !priceRaw || categories.length === 0) { notify('Mohon isi Nama Menu, Harga, dan pilih minimal 1 Kategori!', 'error'); return; }
            
            const price = parseInt(priceRaw);
            let imageUrl = MENUS[id]?.image || DEFAULT_MENU_IMAGE;

            if (fileToUpload) { 
                imageUrl = await uploadImageToCloudinary(fileToUpload); 
                imageFileInput.croppedFile = null; // Hapus file pangkas sementara
                if (!imageUrl) { 
                    notify('Gagal mengunggah gambar menu. Menggunakan foto lama/default.', 'warning'); 
                    imageUrl = MENUS[id]?.image || DEFAULT_MENU_IMAGE;
                }
            }

            const data = {
                id, restaurantId, name, price, category: categories, image: imageUrl, updatedAt: new Date().toISOString()
            };

            MENU_REF.child(id).set(data)
                .then(() => { notify(`Menu ${name} di ${kedaiName} berhasil disimpan!`, 'success'); closeModal('menuModal'); })
                .catch(error => notify('Gagal menyimpan menu: ' + error.message, 'error'));
        };

        window.editMenu = (id) => {
            const m = MENUS[id];
            if (!m) return;
            const r = RESTAURANTS[m.restaurantId];

            document.getElementById('menuId').value = m.id;
            document.getElementById('menuRestaurantId').value = m.restaurantId;
            document.getElementById('menuName').value = m.name;
            
            document.getElementById('menuPriceDisplay').value = formatRupiah(m.price);
            document.getElementById('menuPrice').value = m.price;
            
            document.getElementById('menuTargetKedaiName').textContent = r?.name || 'N/A';
            document.getElementById('menuImagePreview').src = m.image || DEFAULT_MENU_IMAGE;
            document.getElementById('menuImagePreview').style.display = 'block';
            document.getElementById('menuImageFile').value = ''; // Clear file input
            delete document.getElementById('menuImageFile').croppedFile; // Hapus file pangkas

            renderMenuCategoryOptions(m.category || []);
            openModal('menuModal', `Edit Menu: ${m.name}`);
        };

        window.deleteMenu = (id, name) => {
            if (confirm(`Yakin ingin menghapus menu ${name} ini? Tindakan ini tidak dapat dibatalkan!`)) {
                MENU_REF.child(id).remove()
                    .then(() => notify('Menu berhasil dihapus.', 'danger'))
                    .catch(error => notify('Gagal menghapus menu: ' + error.message, 'error'));
            }
        };
        
        // START NEW: CRUD GALLERY
        window.openGalleryFormForRestaurant = (restaurantId, restaurantName) => {
            document.getElementById('galleryFormData').reset();
            document.getElementById('galleryId').value = '';
            document.getElementById('galleryRestaurantId').value = restaurantId;
            document.getElementById('galleryName').value = '';
            document.getElementById('galleryDescription').value = '';
            document.getElementById('galleryTargetKedaiName').textContent = restaurantName;
            document.getElementById('galleryImagePreview').src = DEFAULT_GALLERY_IMAGE; 
            document.getElementById('galleryImagePreview').style.display = 'none';
            document.getElementById('galleryImageFile').value = ''; 
            delete document.getElementById('galleryImageFile').croppedFile; 
            openModal('galleryModal', `Tambah Galeri untuk ${restaurantName}`);
        };

        // START MODIFIED: saveGallery (Non-mandatory fields)
        window.saveGallery = async () => {
            const id = document.getElementById('galleryId').value || GALLERY_REF.push().key;
            const restaurantId = document.getElementById('galleryRestaurantId').value;
            // Gunakan nilai input atau nilai default jika kosong, untuk mencegah error saat tampil di list.
            const name = document.getElementById('galleryName').value || 'Galeri Tanpa Nama'; 
            const description = document.getElementById('galleryDescription').value || '';
            const kedaiName = document.getElementById('galleryTargetKedaiName').textContent;
            
            const imageFileInput = document.getElementById('galleryImageFile');
            const fileToUpload = imageFileInput.croppedFile || imageFileInput.files[0];

            if (!restaurantId) {
                notify('ERROR: ID Kedai tidak ditemukan. Mohon ulangi proses dari Daftar Kedai.', 'error'); return;
            }

            let imageUrl = GALLERIES[id]?.image || ''; // Default image kosong jika tidak ada foto sebelumnya
            const isPublished = GALLERIES[id]?.isPublished !== false; 

            // HANYA UNGGAH JIKA ADA FILE BARU
            if (fileToUpload) { 
                imageUrl = await uploadImageToCloudinary(fileToUpload); 
                imageFileInput.croppedFile = null; 
                if (!imageUrl) { 
                    notify('Gagal mengunggah gambar galeri. Menggunakan foto lama/kosong.', 'warning'); 
                    imageUrl = GALLERIES[id]?.image || '';
                }
            } else {
                // Pertahankan gambar lama jika ada dan tidak ada file baru diupload
                imageUrl = GALLERIES[id]?.image || ''; 
            }
            
            // Pencegahan menyimpan entri BARU yang benar-benar kosong (Nama='Galeri Tanpa Nama', Keterangan='', Foto='')
            if (!document.getElementById('galleryId').value && name === 'Galeri Tanpa Nama' && !description && !imageUrl) {
                 notify('Galeri baru tidak dapat disimpan jika semua Nama, Keterangan, dan Foto kosong.', 'error');
                 return;
            }

            const data = {
                id, restaurantId, name, description, image: imageUrl, 
                isPublished: isPublished,
                updatedAt: new Date().toISOString()
            };

            GALLERY_REF.child(id).set(data)
                .then(() => { notify(`Galeri ${name} di ${kedaiName} berhasil disimpan!`, 'success'); closeModal('galleryModal'); })
                .catch(error => notify('Gagal menyimpan galeri: ' + error.message, 'error'));
        };
        // END MODIFIED: saveGallery

        window.editGallery = (id) => {
            const g = GALLERIES[id];
            if (!g) return;
            const r = RESTAURANTS[g.restaurantId];

            document.getElementById('galleryId').value = g.id;
            document.getElementById('galleryRestaurantId').value = g.restaurantId;
            document.getElementById('galleryName').value = g.name;
            document.getElementById('galleryDescription').value = g.description;
            document.getElementById('galleryTargetKedaiName').textContent = r?.name || 'N/A';
            document.getElementById('galleryImagePreview').src = g.image || DEFAULT_GALLERY_IMAGE;
            document.getElementById('galleryImagePreview').style.display = 'block';
            document.getElementById('galleryImageFile').value = ''; 
            delete document.getElementById('galleryImageFile').croppedFile; 

            openModal('galleryModal', `Edit Galeri: ${g.name}`);
        };

        window.deleteGallery = (id, name) => {
            if (confirm(`Yakin ingin menghapus galeri ${name} ini? Tindakan ini tidak dapat dibatalkan!`)) {
                GALLERY_REF.child(id).remove()
                    .then(() => notify('Galeri berhasil dihapus.', 'danger'))
                    .catch(error => notify('Gagal menghapus galeri: ' + error.message, 'error'));
            }
        };

        window.toggleGalleryVisibility = (id, currentlyPublished) => {
            const newStatus = !currentlyPublished;
            const actionText = newStatus ? 'ditampilkan' : 'disembunyikan';
            GALLERY_REF.child(id).update({ isPublished: newStatus })
                .then(() => notify(`Galeri berhasil ${actionText}!`, 'success'))
                .catch(error => notify('Gagal mengubah visibilitas galeri: ' + error.message, 'error'));
        };
        // END NEW: CRUD GALLERY


        // --- Datalist/Select Population ---
        // MODIFIED: populateDatalists (Added Kedai dropdown for Menu filter)
        const populateDatalists = () => {
            // Populate Kedai Datalist (untuk search kedai)
            const kedaiDatalist = document.getElementById('kedaiNamesList');
            kedaiDatalist.innerHTML = '';
            Object.values(RESTAURANTS).forEach(r => {
                kedaiDatalist.innerHTML += `<option value="${r.name}">`;
            });
            
            // Populate Menu Datalist (untuk search menu)
            const menuNamesDatalist = document.getElementById('menuNamesList');
            menuNamesDatalist.innerHTML = '';
            const uniqueMenuNames = new Set();
            Object.values(MENUS).forEach(m => {
                if (m.name) uniqueMenuNames.add(m.name);
            });
            uniqueMenuNames.forEach(name => {
                menuNamesDatalist.innerHTML += `<option value="${name}">`;
            });

            // START MODIFIED: Populate Kedai Select Dropdown (untuk filter menu)
            const kedaiSelect = document.getElementById('filterMenuKedaiList');
            let kedaiOptions = '<option value="">Semua Kedai</option>'; 
            Object.values(RESTAURANTS).sort((a, b) => a.name.localeCompare(b.name)).forEach(r => {
                kedaiOptions += `<option value="${r.id}">${r.name}</option>`; 
            });
            kedaiSelect.innerHTML = kedaiOptions;
            // END MODIFIED

            // START NEW: Populate Gallery Datalist
            const galleryDatalist = document.getElementById('galleryNamesList');
            galleryDatalist.innerHTML = '';
            const uniqueGalleryNames = new Set();
            Object.values(GALLERIES).forEach(g => {
                if (g.name) uniqueGalleryNames.add(g.name);
            });
            uniqueGalleryNames.forEach(name => {
                galleryDatalist.innerHTML += `<option value="${name}">`;
            });
            // END NEW: Populate Gallery Datalist

            // PERUBAHAN: Populate Menu Category Select Dropdown
            const categorySelect = document.getElementById('filterMenuCategoryList');
            const existingCategories = new Set(); 
            
            Object.values(MENUS).forEach(m => {
                (m.category || []).forEach(cat => existingCategories.add(cat)); 
            });

            // Reset dan isi ulang select
            let categoryOptions = '<option value="">Semua Kategori</option>'; 
            Array.from(existingCategories).sort().forEach(cat => {
                categoryOptions += `<option value="${cat.toLowerCase()}">${cat}</option>`; // Nilai menggunakan huruf kecil untuk filtering
            });
            categorySelect.innerHTML = categoryOptions;
        };

        // --- 🎯 KELOLA DAFTAR KEDAI (Seragam) ---
        // MODIFIED: filterRestaurantList
        window.filterRestaurantList = () => {
             if (!dataLoaded.restaurants || !dataLoaded.menus || !dataLoaded.galleries) { 
                 document.getElementById('restaurantItemsList').innerHTML = `<p style="text-align: center; color: #999; white-space: normal; padding: 10px; width: 300px;">Memuat data kedai...</p>`;
                 return; 
             }
            const searchTerm = document.getElementById('searchRestaurantList').value.toLowerCase().trim();
            // Ambil filter status kedai
            const filterStatus = document.getElementById('filterRestaurantStatusList').value; 
            
            const listContainer = document.getElementById('restaurantItemsList');
            listContainer.innerHTML = '';
            
            let list = Object.values(RESTAURANTS);
                
            // Filter 1: Nama Kedai
            if (searchTerm) {
                list = list.filter(r => r.name.toLowerCase().includes(searchTerm));
            }
            
            // Filter 2: Status Kedai (Open/Closed)
            if (filterStatus) {
                list = list.filter(r => {
                    const { is_open } = checkRestaurantStatus(r.openTime, r.closeTime, r.statusMode, r.manualStatus);
                    return filterStatus === 'open' ? is_open : !is_open;
                });
            }

            if (list.length === 0) { 
                listContainer.innerHTML = `<p style="text-align: center; color: #999; white-space: normal; padding: 10px; width: 300px;">Kedai tidak ditemukan sesuai filter.</p>`;
                return;
            }

            list.sort((a, b) => a.name.localeCompare(b.name));

            list.forEach(r => {
                const { status, is_open } = checkRestaurantStatus(r.openTime, r.closeTime, r.statusMode, r.manualStatus);
                const statusClass = is_open ? 'status-open' : 'status-closed';
                
                const isPublished = r.isPublished !== false; 
                const hideButtonClass = isPublished ? 'btn-warning' : 'btn-primary'; 
                const hideButtonText = isPublished ? 'Sembunyikan' : 'Tampilkan';
                const hideButtonIcon = isPublished ? 'fas fa-eye-slash' : 'fas fa-eye';
                const visibilityText = isPublished ? 'Tampil (Published)' : 'Tersembunyi (Hidden)';
                const visibilityColor = isPublished ? '#4CAF50' : '#ff9800'; 

                const totalMenus = Object.values(MENUS).filter(m => m.restaurantId === r.id).length;
                // START NEW: HITUNG GALERI
                const totalGalleries = Object.values(GALLERIES).filter(g => g.restaurantId === r.id).length;
                // END NEW: HITUNG GALERI

                const item = document.createElement('div');
                item.className = 'list-item-medium'; 
                item.innerHTML = `
                        <img src="${r.image || DEFAULT_RESTAURANT_IMAGE}" alt="${r.name}">
                        <div class="list-item-content">
                            <h3 style="font-size: 16px; margin-bottom: 5px; white-space: normal; overflow: hidden; text-overflow: ellipsis;">${r.name}</h3>
                            <p style="font-size: 12px; color: #555; margin-bottom: 5px;"><i class="fas fa-user-lock"></i> User: ${r.username || 'N/A'}</p>
                            <p style="font-size: 12px; color: #555; margin-bottom: 5px;"><i class="fas fa-map-marker-alt"></i> ${r.address.substring(0, 25)}...</p>
                            
                            <p style="margin-bottom: 5px;">Status: <span class="status-indicator ${statusClass}">${status}</span></p>
                            <p style="margin-bottom: 5px;">Menu: <span style="font-weight: 600; color: var(--primary-color);">${totalMenus} item</span></p>
                            <p style="margin-bottom: 5px;">Galeri: <span style="font-weight: 600; color: #9C27B0;">${totalGalleries} item</span></p>
                            <p style="margin-bottom: 5px;">Visibilitas: <span style="font-size: 12px; font-weight: 600; color: ${visibilityColor};">${visibilityText}</span></p>
                            
                            <div class="actions" style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn-primary btn-sm" onclick="openMenuFormForRestaurant('${r.id}', '${r.name}')"><i class="fas fa-plus"></i> Menu</button>
                                <button class="btn-primary btn-sm" onclick="openGalleryFormForRestaurant('${r.id}', '${r.name}')"><i class="fas fa-images"></i> Galeri</button>
                                <button class="btn-secondary btn-sm" onclick="editRestaurantForm('${r.id}')"><i class="fas fa-edit"></i> Edit</button>
                                
                                <button class="${hideButtonClass} btn-sm" onclick="toggleRestaurantVisibility('${r.id}', ${isPublished})"><i class="${hideButtonIcon}"></i> ${hideButtonText}</button>
                                <button class="btn-danger btn-sm" onclick="deleteRestaurant('${r.id}', '${r.name}')"><i class="fas fa-trash"></i> Hapus</button>
                            </div>
                        </div>
                `;
                listContainer.appendChild(item);
            });
        };
        
        // --- 🎯 KELOLA DAFTAR MENU (Seragam) ---
        // MODIFIED: filterMenuList (Added Kedai ID filter)
        window.filterMenuList = () => {
             if (!dataLoaded.restaurants || !dataLoaded.menus) { 
                 document.getElementById('menuItemsList').innerHTML = `<p style="text-align: center; color: #999; padding: 20px 0;">Memuat data menu...</p>`;
                 return;
             } 
            const searchTerm = document.getElementById('searchMenuList').value.toLowerCase().trim();
            // START MODIFIED: Ambil filter Kedai ID BARU
            const filterKedaiId = document.getElementById('filterMenuKedaiList').value;
            // END MODIFIED
            // Ambil filter status kedai di menu
            const filterKedaiStatus = document.getElementById('filterMenuKedaiStatus').value;
            // PERUBAHAN: Ambil filter kategori dari dropdown select
            const filterCategory = document.getElementById('filterMenuCategoryList').value.toLowerCase().trim();
            
            const listContainer = document.getElementById('menuItemsList');
            listContainer.innerHTML = '';
            
            let filteredMenus = Object.values(MENUS);
            
            // Filter 1: Nama Menu
            if (searchTerm) {
                filteredMenus = filteredMenus.filter(m => m.name.toLowerCase().includes(searchTerm));
            }

            // START MODIFIED: Filter 2: Filter berdasarkan ID Kedai
            if (filterKedaiId) {
                filteredMenus = filteredMenus.filter(m => m.restaurantId === filterKedaiId);
            }
            // END MODIFIED

            // Filter 3 & 4: Status Kedai dan Kategori
            if (filterKedaiStatus || filterCategory) {
                 filteredMenus = filteredMenus.filter(m => {
                    const r = RESTAURANTS[m.restaurantId];
                    if (!r) return false; // Abaikan menu tanpa kedai

                    // Cek Status Kedai
                    if (filterKedaiStatus) {
                        const { is_open } = checkRestaurantStatus(r.openTime, r.closeTime, r.statusMode, r.manualStatus);
                        if (filterKedaiStatus === 'open' && !is_open) return false;
                        if (filterKedaiStatus === 'closed' && is_open) return false;
                    }
                    
                    // Cek Kategori (Sekarang menggunakan select, jadi cocokkan nilai exact)
                    if (filterCategory) {
                        const menuCategoryMatches = (m.category || []).some(cat => cat.toLowerCase() === filterCategory);
                        if (!menuCategoryMatches) return false;
                    }
                    
                    return true;
                });
            }

            if (filteredMenus.length === 0) {
                 listContainer.innerHTML = `<p style="text-align: center; color: #999; padding: 20px 0;">Menu tidak ditemukan sesuai filter.</p>`;
                return;
            }

            filteredMenus.sort((a, b) => a.name.localeCompare(b.name));
            
            const scrollWrapper = document.createElement('div');
            scrollWrapper.className = 'horizontal-scroll-container';
            
            const listMedium = document.createElement('div');
            listMedium.className = 'list-medium';

            filteredMenus.forEach(m => {
                const r = RESTAURANTS[m.restaurantId];
                const rName = r?.name || 'Kedai Dihapus/N/A';
                
                let kedaiStatus = 'N/A';
                let statusClass = 'status-closed';
                if (r) {
                    const { status, is_open } = checkRestaurantStatus(r.openTime, r.closeTime, r.statusMode, r.manualStatus);
                    kedaiStatus = status;
                    statusClass = is_open ? 'status-open' : 'status-closed';
                }
                
                const isPublished = r?.isPublished !== false; 
                
                const item = document.createElement('div');
                item.className = 'list-item-medium'; 
                
                const borderColor = isPublished ? 'var(--primary-color)' : '#ff9800';

                item.innerHTML = `
                    <img src="${m.image || DEFAULT_MENU_IMAGE}" alt="${m.name}">
                    <div class="list-item-content" style="border-left: 5px solid ${borderColor}; padding-left: 10px;">
                        <h3 style="font-size: 16px; margin-bottom: 5px; white-space: normal; overflow: hidden; text-overflow: ellipsis;">${m.name}</h3>
                        <p style="font-size: 14px; color: #4CAF50; font-weight: 600; margin-bottom: 5px;">Rp ${formatRupiah(m.price)}</p>
                        
                        <p style="font-size: 12px; color: #555; margin-bottom: 5px;"><i class="fas fa-store"></i> Kedai: ${rName}</p>
                        
                        <p style="font-size: 12px; margin-bottom: 5px;">Status Kedai: <span class="status-indicator ${statusClass}" style="margin-left: 0;">${kedaiStatus}</span></p>

                        <p style="font-size: 12px; color: #999; margin-bottom: 5px;"><i class="fas fa-tag"></i> Kategori: ${m.category?.join(', ') || 'Lain-lain'}</p>
                        <p style="font-size: 12px; color: #999; margin-bottom: 5px;">Visibilitas Kedai: <span style="font-weight: 600; color: ${isPublished ? '#4CAF50' : '#ff9800'};">${isPublished ? 'Tampil' : 'Tersembunyi'}</span></p>
                        
                        <div class="actions" style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn-secondary btn-sm" onclick="editMenu('${m.id}')"><i class="fas fa-edit"></i> Edit Menu</button>
                            <button class="btn-danger btn-sm" onclick="deleteMenu('${m.id}', '${m.name}')"><i class="fas fa-trash"></i> Hapus</button>
                        </div>
                    </div>
                `;
                listMedium.appendChild(item);
            });
            
            scrollWrapper.appendChild(listMedium);
            listContainer.appendChild(scrollWrapper);
        };
        
        // START NEW: KELOLA DAFTAR GALERI
        window.filterGalleryList = () => {
             if (!dataLoaded.restaurants || !dataLoaded.galleries) { 
                 document.getElementById('galleryItemsList').innerHTML = `<p style="text-align: center; color: #999; padding: 20px 0;">Memuat data galeri...</p>`;
                 return;
             } 
            const searchTerm = document.getElementById('searchGalleryList').value.toLowerCase().trim();
            const filterKedaiStatus = document.getElementById('filterGalleryKedaiStatus').value;
            const filterVisibility = document.getElementById('filterGalleryVisibility').value; 
            
            const listContainer = document.getElementById('galleryItemsList');
            listContainer.innerHTML = '';
            
            let filteredGalleries = Object.values(GALLERIES);
            
            // Filter 1: Nama Galeri/Kedai
            if (searchTerm) {
                filteredGalleries = filteredGalleries.filter(g => {
                    const r = RESTAURANTS[g.restaurantId];
                    const kedaiName = r?.name?.toLowerCase() || '';
                    return g.name.toLowerCase().includes(searchTerm) || kedaiName.includes(searchTerm);
                });
            }

            // Filter 2: Status Kedai
            if (filterKedaiStatus) {
                 filteredGalleries = filteredGalleries.filter(g => {
                    const r = RESTAURANTS[g.restaurantId];
                    if (!r) return false; 
                    const { is_open } = checkRestaurantStatus(r.openTime, r.closeTime, r.statusMode, r.manualStatus);
                    return filterKedaiStatus === 'open' ? is_open : !is_open;
                });
            }
            
            // Filter 3: Visibilitas Galeri
            if (filterVisibility) {
                filteredGalleries = filteredGalleries.filter(g => {
                    const isPublished = g.isPublished !== false;
                    return filterVisibility === 'published' ? isPublished : !isPublished;
                });
            }

            if (filteredGalleries.length === 0) {
                 listContainer.innerHTML = `<p style="text-align: center; color: #999; padding: 20px 0;">Galeri tidak ditemukan sesuai filter.</p>`;
                return;
            }

            filteredGalleries.sort((a, b) => a.name.localeCompare(b.name));
            
            const scrollWrapper = document.createElement('div');
            scrollWrapper.className = 'horizontal-scroll-container';
            
            const listMedium = document.createElement('div');
            listMedium.className = 'list-medium';

            filteredGalleries.forEach(g => {
                const r = RESTAURANTS[g.restaurantId];
                const rName = r?.name || 'Kedai Dihapus/N/A';
                
                let kedaiStatus = 'N/A';
                let statusClass = 'status-closed';
                if (r) {
                    const { status, is_open } = checkRestaurantStatus(r.openTime, r.closeTime, r.statusMode, r.manualStatus);
                    kedaiStatus = status;
                    statusClass = is_open ? 'status-open' : 'status-closed';
                }
                
                const isPublished = g.isPublished !== false; 
                const hideButtonClass = isPublished ? 'btn-warning' : 'btn-primary'; 
                const hideButtonText = isPublished ? 'Sembunyikan' : 'Tampilkan';
                const hideButtonIcon = isPublished ? 'fas fa-eye-slash' : 'fas fa-eye';
                
                const borderColor = isPublished ? '#9C27B0' : '#ff9800'; 

                const item = document.createElement('div');
                item.className = 'list-item-medium'; 
                
                // Override CSS 1:1 ratio untuk menampilkan gambar galeri full size
                item.innerHTML = `
                    <img src="${g.image || DEFAULT_GALLERY_IMAGE}" alt="${g.name}" style="aspect-ratio: auto; height: auto;">
                    <div class="list-item-content" style="border-left: 5px solid ${borderColor}; padding-left: 10px;">
                        <h3 style="font-size: 16px; margin-bottom: 5px; white-space: normal; overflow: hidden; text-overflow: ellipsis;">${g.name}</h3>
                        <p style="font-size: 12px; color: #555; margin-bottom: 5px; white-space: normal;">Keterangan: ${g.description.substring(0, 50)}${g.description.length > 50 ? '...' : ''}</p>
                        
                        <p style="font-size: 12px; color: #555; margin-bottom: 5px;"><i class="fas fa-store"></i> Kedai: ${rName}</p>
                        
                        <p style="font-size: 12px; margin-bottom: 5px;">Status Kedai: <span class="status-indicator ${statusClass}" style="margin-left: 0;">${kedaiStatus}</span></p>

                        <p style="font-size: 12px; color: #999; margin-bottom: 5px;">Visibilitas Galeri: <span style="font-weight: 600; color: ${isPublished ? '#4CAF50' : '#ff9800'};">${isPublished ? 'Tampil' : 'Tersembunyi'}</span></p>
                        
                        <div class="actions" style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn-secondary btn-sm" onclick="editGallery('${g.id}')"><i class="fas fa-edit"></i> Edit Galeri</button>
                            <button class="${hideButtonClass} btn-sm" onclick="toggleGalleryVisibility('${g.id}', ${isPublished})"><i class="${hideButtonIcon}"></i> ${hideButtonText}</button>
                            <button class="btn-danger btn-sm" onclick="deleteGallery('${g.id}', '${g.name}')"><i class="fas fa-trash"></i> Hapus</button>
                        </div>
                    </div>
                `;
                listMedium.appendChild(item);
            });
            
            scrollWrapper.appendChild(listMedium);
            listContainer.appendChild(scrollWrapper);
        };
        // END NEW: KELOLA DAFTAR GALERI


        // --- Inisialisasi ---
        document.addEventListener('DOMContentLoaded', () => {
            // Re-render status setiap detik untuk WIB
            setInterval(updateWibTimeDisplay, 1000); 
            updateWibTimeDisplay(); 
            
            // Set up listener untuk price display (Rupiah formatting)
            document.getElementById('menuPriceDisplay').addEventListener('input', (e) => {
                const rawValue = e.target.value.replace(/\./g, ''); 
                document.getElementById('menuPrice').value = rawValue;
                e.target.value = formatRupiah(rawValue);
            });
            
            fetchAllData();

            // Setup awal status mode
            document.getElementById('statusModeSelect').value = 'auto';
            document.getElementById('manualStatusToggle').checked = true; 
            document.getElementById('manualStatusActualValue').value = 'open';
            toggleManualControls('auto');
            
            // Atur default active section ke Daftar Kedai
            showSection('restaurantList', document.querySelector('.nav-btn[onclick="showSection(\'restaurantList\', this)"]'));
        });
    </script>
</body>
</html>
